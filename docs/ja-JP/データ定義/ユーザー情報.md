[目次](../目次.md) > データ定義 / ユーザー情報

## はじめに
ProjectSansa の **認証・セッション(P1)** を満たす Cassandra スキーマを定義します。  
- 登録/ログインに必要な最小項目のみを**本体テーブル `users`**に持たせます。  
- メール確認(P2)・MFA(P3)は**将来の拡張テーブル**として設計メモのみ提示します（今は作成しません）。

---

## 環境別の前提（Keyspace レプリケーション）
- **dev（単一ノード）**：`replication_factor = 1`  
- **prod/将来クラスタ**：`replication_factor = 3`（クラスタ規模に応じて調整）

> dev で RF=3 を指定すると、単一ノードでは「未満レプリケーション」となり期待どおりに動かないため、**dev は RF=1** を使用します。

---

## スキーマ（P1：登録・ログイン）

### 1) キースペース作成
```sql
-- dev: 単一ノード開発環境
CREATE KEYSPACE IF NOT EXISTS UserManage
  WITH replication = {'class': 'SimpleStrategy', 'replication_factor': 1}
  AND durable_writes = true;

/* prod: 例（クラスタ運用）
CREATE KEYSPACE IF NOT EXISTS UserManage
  WITH replication = {'class': 'SimpleStrategy', 'replication_factor': 3}
  AND durable_writes = true;
*/
```

### 2) テーブル定義（本体）
```sql
USE UserManage;

-- ユーザー本体（P1最小：登録/ログイン）
CREATE TABLE IF NOT EXISTS users (
  user_id         uuid PRIMARY KEY,  -- ユーザーID
  username        text,              -- ログインID相当（アプリ層で一意運用）
  email           text,              -- 将来のメール確認(P2)を見据えて保持
  hashed_password text,              -- パスワードハッシュ（Argon2/BCrypt 等）
  status          text,              -- "active"(P1既定) / "pending_email"(P2) / "locked"(将来)
  created_at      timestamp,         -- 作成日時
  updated_at      timestamp          -- 最終更新日時
) WITH comment = 'ユーザー認証情報（最小構成：P1）';

-- ログイン/重複チェック用のインデックス（当面運用）
CREATE INDEX IF NOT EXISTS users_username_idx ON users (username);
CREATE INDEX IF NOT EXISTS users_email_idx    ON users (email);
```

> **ユニーク性について**  
> Cassandra は RDB のような厳密ユニーク制約を持たないため、**P1 ではアプリ層で「存在チェック→409」**を返します。将来は **LWT**（`IF NOT EXISTS`）＋参照テーブル or **Materialized View** で強化します（後述）。

---

## 確認手順（cqlsh）
```sql
-- cqlsh
DESCRIBE KEYSPACES;

USE UserManage;
DESCRIBE TABLES;

DESCRIBE TABLE users;
```

---

## 運用ノート（P1）

- **登録 `/auth/register`**  
  - `username` で既存チェック → 既存なら **409**  
  - `hashed_password` へ安全なハッシュを保存（Argon2/BCrypt）  
  - `status` は **"active"** をセット（P2 で "pending_email" を使用予定）  
  - `created_at` / `updated_at` をサーバ時刻で設定
- **ログイン `/auth/login`**  
  - `username` で取得 → ハッシュ照合 → OK なら JWT 発行  
  - 失敗は **401**（情報過多なエラーメッセージは避ける）

---

## 将来拡張（設計メモのみ・今は作らない）

> P1 完了後、メール確認(P2)・MFA(P3)の導入時に**追記・作成**します。

### P2: メール確認（Email Verification）
```sql
/* P2 で追加予定
CREATE TABLE IF NOT EXISTS email_verifications (
  token       text PRIMARY KEY,  -- 署名付き/ランダムトークン
  user_id     uuid,
  email       text,
  expires_at  timestamp,
  used        boolean
);
*/
```

### P3: MFA（TOTP）
```sql
/* P3 で追加予定
CREATE TABLE IF NOT EXISTS user_mfa (
  user_id     uuid PRIMARY KEY,
  totp_secret text,       -- 暗号化保存（KMS/OS保護）
  enabled     boolean,
  updated_at  timestamp
);

CREATE TABLE IF NOT EXISTS user_mfa_recovery (
  user_id     uuid,
  code_hash   text,       -- 使い捨て（ハッシュ保存）
  used        boolean,
  PRIMARY KEY (user_id, code_hash)
);
*/
```

### 将来のユニーク強化（オプション）
```sql
/* 参照テーブル + LWT 案（P2/P3の前後で導入検討）
CREATE TABLE IF NOT EXISTS users_by_username (username text PRIMARY KEY, user_id uuid);
CREATE TABLE IF NOT EXISTS users_by_email    (email    text PRIMARY KEY, user_id uuid);
-- 登録時は users_by_username に IF NOT EXISTS で確保 → 成功時に users 本体 INSERT
*/
```

---

## 変更履歴
- **2025-09-23**: P1向けに最小スキーマへ整理。dev=RF1 を明記、`status` 列を追加、将来拡張（P2/P3）の設計メモを追記。
- （参考）旧版では `additional_auth map<text,text>` 等を含む汎用カラムがありましたが、P1では未使用とし、将来は専用テーブルで扱います。

***
[目次](../目次.md) > データ定義 / ユーザー情報
