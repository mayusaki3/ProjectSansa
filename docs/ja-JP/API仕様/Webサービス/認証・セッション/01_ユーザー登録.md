[目次](../../../目次.md) > API仕様 > Webサービス> [認証・セッション 目次](目次.md) > ユーザー登録
# ユーザー登録（前段メール検証 A案）

## 目的
未検証アカウントを残さず、到達性を担保したうえで本登録を行う。

## フロー（操作）
1. **メール入力**: `POST /auth/pre-register { email }`（外形200）
2. **コード入力**: メールの6桁コードを `POST /auth/verify-email { email, code }`
   - 成功: `preRegId` を受領（TTL=10分、1回限り）
3. **本登録**: `POST /auth/register { preRegId, accountId, password?, language }`
   - 本件では **primaryAuth=passkey** のため `password` は省略可（Web向けに併用する場合のみ送る）
4. 完了後 `emailVerified=true` のユーザーが作成される。

## API 仕様
### POST /auth/pre-register
- 入力: `{ email }`
- 制約: 書式, MX, 使い捨てドメイン拒否, レート制限(60s, 10/day)
- 副作用: 検証コード発行（最新のみ有効）

### POST /auth/verify-email
- 入力: `{ email, code }`
- 成功: `{ preRegId, expiresIn }`（短寿命）

### POST /auth/register
- 入力: `{ preRegId, accountId, language }` (+ `password` 任意)
- 成功: ユーザー作成、`emailVerified=true`

## i18n
- リクエスト `Accept-Language` を解釈し、`Content-Language` を返す。
- メール本文はロケール別テンプレートを使用。

## エラー
- `invalid_code` / `expired` / `rate_limited` / `already_registered` / `blocked_domain`

## セキュリティ
- 列挙対策: `/auth/pre-register` は外形200。
- `preRegId` は1回限り・TTL内のみ有効。

## 参照
- [ログイン](./ログイン.md)
- [WebAuthn（パスキー）](./WebAuthn.md)
- [MFA（TOTP/メールOTP）](./MFA.md)
- [セッション管理](./セッション管理.md)

---
[目次](../../../目次.md) > API仕様 > Webサービス> [認証・セッション 目次](目次.md) > ユーザー登録