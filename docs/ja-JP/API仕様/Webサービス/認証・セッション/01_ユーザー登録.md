[目次](../../../目次.md) > API仕様 > Webサービス> [認証・セッション 目次](目次.md) > ユーザー登録
# ユーザー登録（Pre-Register / Verify / Register）

本章はメール事前登録→コード確認→本登録のフローを定義する。  
**preRegId はクライアント境界で String（UUID文字列）** とし、内部では UUID を保持する。

## エンドポイント

| # | 概要 | Method / Path |
|---|---|---|
| 1 | 事前登録（メール送信トリガ） | `POST /auth/pre-register` |
| 2 | 認証コード確認（preRegId払い出し） | `POST /auth/verify-email` |
| 3 | 本登録（ユーザー作成） | `POST /auth/register` |
||||

## リクエスト/レスポンス DTO（ドキュメント定義）

### 1) POST /auth/pre-register

**Request: `PreRegisterRequest`**
| フィールド | 型 | 必須 | 制約 |
|---|---|---|---|
| email | string | ✅ | RFC準拠のメール形式。使い捨てドメイン不可（内部判定）。 |
| language | string | 任意 | `^[a-z]{2}(-[A-Z]{2})?$`（例: `ja`, `ja-JP`, `en-US`） |
|||||

**Response: `PreRegisterResponse`**
| フィールド | 型 | 説明 |
|---|---|---|
| success | boolean | 送信トリガを受理したか |
| throttleMs | number | レート制御ヒント（ミリ秒） |
||||

**Status**
- 200/202: 正常受理（メール送信は非同期）
- 400: 入力不正（`problem+json`）
- 429: レート制限
- 5xx: サーバエラー

### 2) POST /auth/verify-email

**Request: `VerifyEmailRequest`**
| フィールド | 型 | 必須 | 制約 |
|---|---|---|---|
| email | string | ✅ | 上記と同様 |
| code | string | ✅ | 桁: 6〜10、TTL=5分（最新発行のみ有効） |
|||||

**Response: `VerifyEmailResponse`**
| フィールド | 型 | 必須 | 説明 |
|---|---|---|---|
| preRegId | string | ✅ | 以降 `/auth/register` で使用（UUID文字列） |
| expiresIn | number | ✅ | preRegId の残存秒数 |
|||||

**Status**
- 200: 成功（`preRegId` 発行）
- 400: `invalid_code` / `expired` / `mismatch`
- 409: 既に登録済み（`already_registered`）
- 429, 5xx

### 3) POST /auth/register

**Request: `RegisterRequest`**
| フィールド | 型 | 必須 | 制約 |
|---|---|---|---|
| preRegId | string | ✅ | `verify-email` で付与。TTL=10分、**1回限り** |
| accountId | string | ✅ | 長さ 3〜64、英数と `._-`（サブセット提案） |
| password | string | 任意 | 8〜128（パスキー主体のため任意可。方針はプロダクト設定に従う） |
| language | string | 任意 | `^[a-z]{2}(-[A-Z]{2})?$` |
|||||

**Response: `RegisterResponse`**
| フィールド | 型 | 説明 |
|---|---|---|
| success | boolean | 作成可否 |
| userId | string | 内部ユーザー ID |
| emailVerified | boolean | 事前に検証済みのため通常 `true` |
||||

**Status**
- 201: ユーザー作成
- 400: 入力不正
- 409: `account_id_taken`
- 410: `preRegId` 失効
- 429, 5xx

## バリデーション（要約）
- `email`: RFC準拠、正規化（小文字化/ドメイン正規化）、MX/Disposable 判別は実装判断
- `code`: 6〜10桁、TTL=5m、**最新のみ有効**
- `preRegId`: TTL=10m、**1回限り**

## エラーモデル（共通）
`application/problem+json` を返す：
```json
{
  "type": "https://errors.sansa.dev/auth/invalid-code",
  "title": "Invalid verification code",
  "status": 400,
  "detail": "The code has expired.",
  "errors": [{"field":"code","reason":"expired"}],
  "traceId": "..."
}
```

## i18n
- 入力: Accept-Language を解釈
- 出力: Content-Language を設定（エラーメッセージも含め多言語可）

## レート制限
- 事前登録/コード再送: 例) 60s、1日10回/メール/デバイス/IP など（組み合わせ）
- レスポンスに throttleMs、ヘッダに RateLimit-*/Retry-After

## 参照
- [ログイン](02_ログイン.md)
- [WebAuthn（パスキー）](03_WebAuthn.md)
- [MFA（TOTP/メールOTP）](04_MFA.md)
- [セッション管理](05_セッション管理.md)

---
[目次](../../../目次.md) > API仕様 > Webサービス> [認証・セッション 目次](目次.md) > ユーザー登録