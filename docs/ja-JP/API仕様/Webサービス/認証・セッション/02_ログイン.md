[目次](../../../目次.md) > API仕様 > Webサービス> [認証・セッション 目次](目次.md) > ログイン
# ログイン（Password / Passkey / MFA誘導）

本章はログインフロー全体を定義する。  
**最終レスポンスは LoginResponse に統一**し、`authenticated`（真偽）と `mfaRequired`（真偽）で分岐する。

## エンドポイント

| # | 概要 | Method / Path |
|---|---|---|
| 1 | パスワード/ID で一次認証 | `POST /auth/login` |
| 2 | （パスキー）認証チャレンジ取得 | `GET /webauthn/challenge` |
| 3 | （パスキー）アサーション送信 | `POST /webauthn/assertion` |
||||

## リクエスト/レスポンス DTO（ドキュメント定義）

### A) `POST /auth/login`

**Request: `LoginRequest`**
| フィールド | 型 | 必須 | 説明 |
|---|---|---|---|
| identifier | string | ✅ | `email` もしくは `accountId`（採用方針は実装で統一） |
| password | string | ✅ | パスキーメインの場合でもサブとして許可可能 |
|||||

**Response: `LoginResponse`**（成功/MFA要/失敗を単一定義で表現）
| フィールド | 型 | 説明 |
|---|---|---|
| authenticated | boolean | 真なら `session/tokens/user` が埋まる |
| mfaRequired | boolean | 真なら `mfa` が埋まる |
| session | `SessionInfo` | 現在セッション |
| tokens | `LoginTokens` | AT/RT |
| amr | string[] | 認証手段（例: `["pwd"]`、後続で `"mfa"` 追加） |
| user | `UserSummary` | 概要 |
| mfa | `MfaInfo` | `mfaRequired=true` 時のみ。`factors` と `challengeId` |
||||

**Status**
- 200: 認証成功 or MFA 必須（本文で判別）
- 401: 資格情報不正
- 423: アカウントロック（試行回数超過など）
- 429, 5xx

### B) WebAuthn（概要のみ。詳細は「03_WebAuthn.md」）

**`GET /webauthn/challenge` → WebAuthnChallengeResponse**
- `challenge`, `rpId`, `timeout`, `userVerification ("preferred")`

**`POST /webauthn/assertion` → LoginResponse**
- 成功: `authenticated=true, amr+=["webauthn"]`
- MFA必要: `authenticated=false, mfaRequired=true`

## エラーモデル（共通）
`problem+json`。代表 `type` 例：
- `invalid_credentials`, `mfa_required`, `locked`, `rate_limited`

## セキュリティと AMR
- `amr` は `"pwd"`, `"webauthn"`, `"mfa"` などの手段を格納
- 監査ログに `amr` とクライアント情報（IP/UA/指紋）を記録

## トークンと回転
- `accessToken`/`refreshToken` を発行
- RT 再利用検知 → **トークンファミリ無効化**（`token_version` をインクリメント）

## 参照
- [ユーザー登録](01_ユーザー登録.md)
- [WebAuthn（パスキー）](03_WebAuthn.md)
- [MFA（TOTP/メールOTP）](04_MFA.md)
- [セッション管理](05_セッション管理.md)

---
[目次](../../../目次.md) > API仕様 > Webサービス> [認証・セッション 目次](目次.md) > ログイン