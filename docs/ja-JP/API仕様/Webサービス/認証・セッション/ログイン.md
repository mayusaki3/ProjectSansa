# docs/ja-JP/API仕様/認証・セッション/ログイン.md

## 目的
既存の「ユーザー登録 API」に続く**ログイン処理**の仕様を定義する。将来のMFA/WebAuthn拡張や言語ネゴシエーションに配慮した最小契約。

## エンドポイント
- **POST** `/auth/login`
- **認証**: 不要（エンドポイント自体）

## リクエスト
```http
POST /auth/login
Content-Type: application/json
Accept-Language: ja-JP, en;q=0.8

{
  "usernameOrEmail": "<str>",
  "password": "<str>",
  "mfa": {
    "type": "totp",           // 将来: "webauthn"
    "code": "123456"          // 初回は省略可（サーバーが challenge を返す）
  },
  "remember": true              // セッショントークンの寿命延長（規定値は短寿命）
}
```

## レスポンス
### 200 OK（MFA不要 or 既に満たした場合）
```json
{
  "user": { "id": "u_123", "username": "alice" },
  "accessToken": "<jwt>",
  "refreshToken": "<jwt>",
  "expiresIn": 3600,
  "contentLanguage": "ja-JP"
}
```

### 401 Unauthorized（MFAが必要）
```json
{
  "error": "mfa_required",
  "mfa": {
    "factors": ["totp"],
    "challengeId": "ch_abc",
    "expiresIn": 120
  }
}
```

### 4xx/5xx エラー型（一例）
- `invalid_credentials` / `locked` / `rate_limited` / `temporarily_unavailable`

## ヘッダ
- `Content-Language`: 応答言語（ユーザー設定 > `?lang` > `Accept-Language` の優先順位）

## セキュリティ
- パスワードは PBKDF2/bcrypt/Argon2 いずれかでハッシュ化
- リフレッシュトークンは失効・ローテーション（1回使い切り）
- MFA チャレンジ（TOTP）は時刻スキュー許容（±1step）、再利用不可

## 監査
- 成功/失敗/ロックアウト/レート制限をイベント出力

---

# docs/ja-JP/API仕様/認証・セッション/ユーザー登録_単体テスト内容.md

## 目的
`/auth/register` の単体テスト観点・ケース・環境を定義し、CI で自動実行する。

## テスト環境
- **実行基盤**: GitHub Actions（Linux）
- **DB**: Cassandra 単一ノード（Compose）
- **メール**: MailHog（SMTPモック: 1025/8025）
- **時刻**: テストごとに固定クロック（TOTP/有効期限の安定化）
- **ベースURL**: `http://api:8080`

### docker-compose（抜粋・例）
```yaml
services:
  api:
    build: .
    environment:
      - SANSA_ENV=test
      - MAIL_SMTP_HOST=mailhog
      - MAIL_SMTP_PORT=1025
    depends_on: [cassandra, mailhog]
  cassandra:
    image: cassandra:5
  mailhog:
    image: mailhog/mailhog
    ports: ["1025:1025", "8025:8025"]
```

## 観点
1. **入力検証**: username/password/email の形式・長さ・禁止語
2. **一意制約**: username・email の重複登録不可
3. **初期状態**: `emailVerified=false`, `mfa.enrolled=false`, `settings.language` 既定値
4. **メール送信**: 検証メールが MailHog に到達（件名・本文・ワンタイムトークン）
5. **リトライ/再送**: 検証メールの再送クールダウン、最新トークンのみ有効
6. **耐故障**: DB 失敗時のロールバック（ユーザー半端状態なし）
7. **監査**: 登録イベントの記録

## ケース一覧（例）
- 正常: 最小項目（P1: username+password）
- 正常: P2（email 付き）→ 検証メール1通
- 異常: username 重複 / email 重複 / password 弱すぎ
- 異常: メール送信失敗→ リトライ・警告（登録は成功し検証待ち）
- 異常: バリデーションエラーの i18n（`Accept-Language`）

## 成果物
- カバレッジ: lines ≥ 80% / branches ≥ 70%
- MailHog キャプチャ: 重要ケースはスナップショット保存（CI artifact）

---

# docs/ja-JP/API仕様/認証・セッション/ログイン_単体テスト内容.md

## 目的
`/auth/login` と MFA チャレンジの単体テスト観点・ケース・環境を定義する。

## テスト環境
- **実行基盤**: GitHub Actions（Linux）
- **DB**: Cassandra 単一ノード（Compose）
- **メール**: MailHog（パスワードリセット用の前準備で使用）
- **時刻**: 固定クロック（TOTP検証）
- **シードデータ**: 事前に `verifiedUser` / `mfaEnrolledUser` を投入

## 観点
1. **資格情報**: 正常・誤パスワード・存在しないユーザー
2. **ロックアウト**: 連続失敗で一時ロック→時間経過で解除
3. **MFA 要求**: enrolled の場合に `mfa_required` を返す
4. **TOTP**: 正常/誤り/時刻ずれ/再利用/連続リクエスト
5. **トークン**: access/refresh の発行・期限・ローテーション
6. **i18n**: `Accept-Language` とユーザー設定の優先順位、`Content-Language` 付与
7. **監査**: 成功/失敗/ロック/解除のイベント

## ケース一覧（例）
- 正常: パスワードのみ（MFA未登録）→ 200
- 正常: `mfa_required` → `challengeId` 受領 → 正しい TOTP で 200
- 異常: `invalid_credentials` / `locked` / `rate_limited`
- 異常: TOTP 再利用 / 時刻窓外 / 間違いコード
- 異常: 未対応ロケール要求時のフォールバック

## 成果物
- カバレッジ: lines ≥ 80% / branches ≥ 70%
- ロックアウト・MFA のカウンタ/時刻挙動はプロパティ駆動テストを併用

---

# 付録：目次と整合のための差分案

- 追加: `docs/ja-JP/API仕様/認証・セッション/ログイン.md`
- 追加: `docs/ja-JP/API仕様/認証・セッション/ユーザー登録_単体テスト内容.md`
- 追加: `docs/ja-JP/API仕様/認証・セッション/ログイン_単体テスト内容.md`
- 目次更新: `Webサービス 概要・目次.md` に「ログイン」リンクが存在する前提を維持し、パスを現行規約に合わせる（相対リンク）

> 備考: 登録API仕様は既存の `ユーザー登録.md` の記述（エンドポイント・目的）に合わせること。

